<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Buscar Modelos</title>
</head>
<body>

<h1>Buscar Modelos</h1>

<!-- Botón para consultar todas las marcas -->
<button onclick="consultarTodasLasMarcas()">Consultar Todas las Marcas</button>

<!-- Lista desplegable para seleccionar la marca -->
<label for="brandDropdown">Selecciona la Marca:</label>
<select id="brandDropdown" onchange="cambiarMarca()">
  <option value="">Seleccione una marca</option>
  <!-- Las opciones se llenarán dinámicamente con JavaScript -->
</select>

<!-- Lista desplegable para seleccionar el grupo -->
<label for="groupDropdown">Selecciona el Grupo:</label>
<select id="groupDropdown">
  <!-- Las opciones se llenarán dinámicamente con JavaScript -->
</select>

<button onclick="buscarModelos()">Buscar Modelos</button>

<!-- Tabla para mostrar modelos -->
<table id="modelos-table">
  <thead>
    <tr>
      <th>CODIA</th>
      <th>Descripción</th>
      <th>Ver Precios</th>
    </tr>
  </thead>
  <tbody>
    <!-- Las filas se llenarán dinámicamente con JavaScript -->
  </tbody>
</table>

<!-- Tabla para mostrar precios -->
<table id="precios-table">
  <thead>
    <tr>
      <th>Año</th>
      <th>Precio</th>
    </tr>
  </thead>
  <tbody>
    <!-- Las filas se llenarán dinámicamente con JavaScript -->
  </tbody>
</table>

<script>
  function consultarTodasLasMarcas() {
    const apiUrl = '/obtener-marcas';

    fetch(apiUrl)
      .then(response => response.json())
      .then(data => {
        llenarMarcasEnDropdown(data.marcas);
        console.log('Marcas obtenidas:', data.marcas.length);
      })
      .catch(error => {
        console.error('Error al cargar las marcas:', error);
        // Manejar el error según tus necesidades
      });
  }

  function llenarMarcasEnDropdown(marcas) {
    const brandDropdown = document.getElementById('brandDropdown');

    // Limpiar opciones antiguas
    brandDropdown.innerHTML = '<option value="">Seleccione una marca</option>';

    // Llenar opciones con las marcas recibidas
    marcas.forEach(marca => {
      const option = document.createElement('option');
      option.value = marca.BrandsId;
      option.textContent = marca.NombreMarca;
      brandDropdown.appendChild(option);
    });
  }

  async function llenarGruposEnDropdown(brandId) {
    const apiUrlGrupos = `/obtener-grupos/${brandId}`;

    try {
      const response = await fetch(apiUrlGrupos);
      const data = await response.json();

      const groupDropdown = document.getElementById('groupDropdown');

      // Limpiar opciones antiguas
      groupDropdown.innerHTML = '<option value="">Seleccione un grupo</option>';

      // Llenar opciones con los grupos recibidos
      data.grupos.forEach(grupo => {
        const option = document.createElement('option');
        option.value = grupo.GroupId;
        option.textContent = grupo.NombreGrupo;
        groupDropdown.appendChild(option);
      });

      console.log('Grupos obtenidos:', data.grupos.length);
    } catch (error) {
      console.error('Error al cargar los grupos:', error);
      // Manejar el error según tus necesidades
    }
  }

  function cambiarMarca() {
    const brandDropdown = document.getElementById('brandDropdown');
    const selectedBrandId = brandDropdown.value;

    if (selectedBrandId) {
      llenarGruposEnDropdown(selectedBrandId);
    }
  }

  async function buscarModelos() {
    const brandDropdown = document.getElementById('brandDropdown');
    const groupDropdown = document.getElementById('groupDropdown');
    const selectedBrandId = brandDropdown.value;
    const selectedGroupId = groupDropdown.value;

    if (!selectedBrandId) {
      alert('Seleccione una marca antes de buscar modelos.');
      return;
    }

    if (!selectedGroupId) {
      alert('Seleccione un grupo antes de buscar modelos.');
      return;
    }

    const apiUrlModelos = `/obtener-modelos/${selectedBrandId}/${selectedGroupId}`;

    try {
      const response = await fetch(apiUrlModelos);
      const data = await response.json();

      console.log('Modelos obtenidos:', data.modelos);

      // Mostrar modelos en una tabla (puedes adaptar esta parte según tu necesidad)
      const modelosTable = document.getElementById('modelos-table');
      modelosTable.innerHTML = '<thead><tr><th>CODIA</th><th>Descripción</th><th>Ver Precios</th></tr></thead><tbody></tbody>';

      data.modelos.forEach(modelo => {
        const row = modelosTable.querySelector('tbody').insertRow();
        row.insertCell(0).textContent = modelo.codia;
        row.insertCell(1).textContent = modelo.description;

        // Botón para ver precios
        const btnVerPrecios = document.createElement('button');
        btnVerPrecios.textContent = 'Ver Precios';
        btnVerPrecios.onclick = () => verPrecios(modelo.codia);
        row.insertCell(2).appendChild(btnVerPrecios);
      });
    } catch (error) {
      console.error('Error al cargar los modelos:', error);
      // Manejar el error según tus necesidades
    }
  }

  async function verPrecios(codia) {
    const apiUrlPrecios = `/obtener-precios/${codia}`;

    try {
      const response = await fetch(apiUrlPrecios);
      const data = await response.json();

      console.log('Precios obtenidos:', data.precios);

      // Mostrar precios en una tabla (puedes adaptar esta parte según tu necesidad)
      const preciosTable = document.getElementById('precios-table');
      preciosTable.innerHTML = '<thead><tr><th>Año</th><th>Precio</th></tr></thead><tbody></tbody>';

      data.precios.forEach(precio => {
        const row = preciosTable.querySelector('tbody').insertRow();
        row.insertCell(0).textContent = precio.year;
        row.insertCell(1).textContent = precio.price;
      });
    } catch (error) {
      console.error('Error al cargar los precios:', error);
      // Manejar el error según tus necesidades
    }
  }
</script>

</body>
</html>